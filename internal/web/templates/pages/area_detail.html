{{define "content"}}
<style>
    @keyframes itemFadeIn {
        from { opacity: 0; transform: translateY(4px); }
        to   { opacity: 1; transform: translateY(0); }
    }
    .item-row-entering {
        animation: itemFadeIn 0.25s ease both;
    }
    .analyse-scanning {
        font-size: 0.65rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: var(--accent);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }
    .analyse-scanning .spinner {
        width: 10px; height: 10px;
        border: 1.5px solid rgba(79,195,247,0.25);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 0.7s linear infinite;
        flex-shrink: 0;
    }
</style>
<main class="page">
    <a href="/areas" class="detail-back">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        All areas
    </a>

    <div class="detail-layout">
        <!-- Photo column -->
        <div class="detail-photo-col">
            <div class="detail-photo-block" id="photo-block">
                {{if .Photo}}
                    <img src="/areas/{{.Area.ID}}/photo" alt="Photo of {{.Area.Name}}">
                {{else}}
                    <div class="photo-empty">
                        <span class="photo-empty-icon">üì∑</span>
                        <span class="photo-empty-text">No photo yet</span>
                    </div>
                {{end}}
            </div>
            <form id="upload-form" enctype="multipart/form-data" class="detail-upload"
                  onsubmit="startStream(event, {{.Area.ID}})">
                <input type="file" id="photo-input" name="image" accept="image/*" required
                       onchange="previewPhoto(this)">
                <button type="submit" class="btn btn-primary btn-sm" id="upload-btn">
                    <span id="upload-btn-label">Analyse</span>
                    <span id="upload-btn-spinner" style="display:none;width:11px;height:11px;border:1.5px solid rgba(9,12,16,0.3);border-top-color:var(--void);border-radius:50%;animation:spin 0.7s linear infinite"></span>
                </button>
            </form>
        </div>

        <!-- Content column -->
        <div class="detail-content-col">
            <div class="detail-header">
                <div>
                    <div class="detail-title">{{.Area.Name}}</div>
                    <div class="detail-date">Added {{.Area.CreatedAt.Format "02 Jan 2006"}}</div>
                </div>
                <button class="btn btn-danger btn-sm"
                        hx-delete="/areas/{{.Area.ID}}"
                        hx-confirm="Delete {{.Area.Name}} and all its items?"
                        hx-push-url="/areas">
                    Delete
                </button>
            </div>

            <p class="section-label">Items</p>
            <div id="items">
                {{template "item_list" .Items}}
            </div>
        </div>
    </div>
</main>

<script>
function previewPhoto(input) {
    if (input.files[0]) {
        const url = URL.createObjectURL(input.files[0]);
        document.getElementById('photo-block').innerHTML =
            '<img src="' + url + '" alt="Selected photo" style="width:100%;height:100%;object-fit:cover;display:block;">';
    }
}

// On page load: if a photo exists but no items are shown, analysis may be
// in progress. Poll /areas/{id}/items until items appear.
(function() {
    const hasPhoto = {{if .Photo}}true{{else}}false{{end}};
    const hasItems = {{if .Items}}true{{else}}false{{end}};
    if (!hasPhoto || hasItems) return;

    const areaID = {{.Area.ID}};
    const itemsEl = document.getElementById('items');
    itemsEl.innerHTML = '<div class="analyse-scanning"><span class="spinner"></span>Scanning&hellip;</div>';

    let attempts = 0;
    const maxAttempts = 60; // ~2 min at 2 s intervals
    function poll() {
        if (attempts++ >= maxAttempts) {
            itemsEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-text">No items detected</div></div>';
            return;
        }
        fetch('/areas/' + areaID + '/items')
            .then(function(r) { return r.text(); })
            .then(function(html) {
                if (html.includes('item-row')) {
                    itemsEl.innerHTML = html;
                } else {
                    setTimeout(poll, 2000);
                }
            })
            .catch(function() { setTimeout(poll, 2000); });
    }
    setTimeout(poll, 2000);
})();

function startStream(evt, areaID) {
    evt.preventDefault();

    const form = document.getElementById('upload-form');
    const itemsEl = document.getElementById('items');
    const btnLabel = document.getElementById('upload-btn-label');
    const btnSpinner = document.getElementById('upload-btn-spinner');
    const uploadBtn = document.getElementById('upload-btn');
    const fileInput = document.getElementById('photo-input');

    // Capture form data BEFORE disabling inputs
    const formData = new FormData(form);

    // Show uploading state ‚Äî replace button label with spinner, disable file picker
    btnLabel.style.display = 'none';
    btnSpinner.style.display = 'inline-block';
    uploadBtn.disabled = true;
    fileInput.disabled = true;

    // Clear items and show scanning indicator
    itemsEl.innerHTML = '<div class="analyse-scanning"><span class="spinner"></span>Scanning&hellip;</div><table class="item-table"><thead><tr><th class="item-table-th item-table-idx">#</th><th class="item-table-th">Name</th><th class="item-table-th">Qty</th><th class="item-table-th">Notes</th></tr></thead><tbody id="stream-list"></tbody></table>';
    const list = document.getElementById('stream-list');
    let itemIndex = 0;

    let streamFinished = false;

    fetch('/areas/' + areaID + '/photos/stream', {
        method: 'POST',
        body: formData,
    }).then(function(resp) {
        if (!resp.ok) {
            throw new Error('Upload failed: ' + resp.status);
        }

        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let buf = '';

        function pump() {
            return reader.read().then(function(result) {
                if (result.done) {
                    finishStream();
                    return;
                }
                buf += decoder.decode(result.value, { stream: true });

                // Process complete SSE lines
                const lines = buf.split('\n');
                buf = lines.pop(); // keep incomplete last chunk

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const json = line.slice(6).trim();
                        try {
                            const item = JSON.parse(json);
                            appendItem(item, ++itemIndex);
                        } catch(e) { /* skip malformed */ }
                    } else if (line.startsWith('event: done')) {
                        finishStream();
                        return;
                    }
                }
                return pump();
            });
        }

        return pump();
    }).catch(function(err) {
        console.error('Stream error:', err);
        finishStream(true);
    });

    function appendItem(item, idx) {
        const tr = document.createElement('tr');
        tr.className = 'item-row item-row-entering';
        const idxStr = String(idx).padStart(2, '0');
        tr.innerHTML =
            '<td class="item-table-td item-table-idx">' + idxStr + '</td>' +
            '<td class="item-table-td item-name">' + esc(item.name) + '</td>' +
            '<td class="item-table-td item-qty">' + esc(item.quantity || '') + '</td>' +
            '<td class="item-table-td item-notes">' + esc(item.notes || '') + '</td>';
        list.appendChild(tr);
    }

    function finishStream(error) {
        if (streamFinished) return;
        streamFinished = true;

        // Remove scanning indicator
        const scanning = itemsEl.querySelector('.analyse-scanning');
        if (scanning) scanning.remove();

        // If no items landed, show empty state
        if (list && list.children.length === 0) {
            if (error) {
                itemsEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div class="empty-state-text">Analysis failed ‚Äî please try again</div></div>';
            } else {
                itemsEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-text">No items detected</div></div>';
            }
        }

        // Restore button and file picker
        btnLabel.style.display = '';
        btnSpinner.style.display = 'none';
        uploadBtn.disabled = false;
        fileInput.disabled = false;
    }

    function esc(str) {
        return String(str)
            .replace(/&/g,'&amp;')
            .replace(/</g,'&lt;')
            .replace(/>/g,'&gt;')
            .replace(/"/g,'&quot;');
    }
}
</script>
{{end}}
