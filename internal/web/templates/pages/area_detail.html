{{define "content"}}
<style>
    @keyframes itemFadeIn {
        from { opacity: 0; transform: translateY(4px); }
        to   { opacity: 1; transform: translateY(0); }
    }
    .item-row-entering {
        animation: itemFadeIn 0.25s ease both;
    }
    .analyse-scanning {
        font-size: 0.65rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: var(--accent);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }
    .analyse-scanning .spinner {
        width: 10px; height: 10px;
        border: 1.5px solid rgba(79,195,247,0.25);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 0.7s linear infinite;
        flex-shrink: 0;
    }
    .file-label.disabled {
        opacity: 0.4;
        pointer-events: none;
        cursor: default;
    }
</style>
<main class="page">
    <a href="/areas" class="detail-back">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        All areas
    </a>

    <div class="detail-layout">
        <!-- Photo column -->
        <div class="detail-photo-col">
            <div class="detail-photo-block" id="photo-block">
                {{if .Photo}}
                    <img src="/areas/{{.Area.ID}}/photo" alt="Photo of {{.Area.Name}}">
                {{else}}
                    <div class="photo-empty">
                        <span class="photo-empty-icon">üì∑</span>
                        <span class="photo-empty-text">No photo yet</span>
                    </div>
                {{end}}
            </div>
            <form id="upload-form" enctype="multipart/form-data" class="detail-upload"
                  onsubmit="startStream(event, {{.Area.ID}})">
                <label class="file-label">
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>
                    <span class="file-label-text" id="file-name-display">Choose photo</span>
                    <input type="file" name="image" accept="image/*" capture="environment" required
                           onchange="previewPhoto(this)">
                </label>
                <button type="submit" class="btn btn-primary btn-sm" id="upload-btn">
                    <span id="upload-btn-label">Analyse</span>
                    <span id="upload-btn-spinner" style="display:none;width:11px;height:11px;border:1.5px solid rgba(9,12,16,0.3);border-top-color:var(--void);border-radius:50%;animation:spin 0.7s linear infinite"></span>
                </button>
            </form>
        </div>

        <!-- Content column -->
        <div class="detail-content-col">
            <div class="detail-header">
                <div>
                    <div class="detail-title">{{.Area.Name}}</div>
                    <div class="detail-date">Added {{.Area.CreatedAt.Format "02 Jan 2006"}}</div>
                </div>
                <button class="btn btn-danger btn-sm"
                        hx-delete="/areas/{{.Area.ID}}"
                        hx-confirm="Delete {{.Area.Name}} and all its items?"
                        hx-push-url="/areas">
                    Delete
                </button>
            </div>

            <p class="section-label">Items</p>
            <div id="items">
                {{template "item_list" .Items}}
            </div>
        </div>
    </div>
</main>

<script>
function previewPhoto(input) {
    document.getElementById('file-name-display').textContent = input.files[0]?.name || 'Choose photo';
    if (input.files[0]) {
        const url = URL.createObjectURL(input.files[0]);
        document.getElementById('photo-block').innerHTML =
            '<img src="' + url + '" alt="Selected photo" style="width:100%;height:100%;object-fit:cover;display:block;">';
    }
}

// On page load: if sessionStorage says analysis was in-progress for this area,
// show a scanning spinner and poll /areas/{id}/items until items appear.
(function() {
    const areaID = {{.Area.ID}};
    const key = 'analysing:' + areaID;
    if (!sessionStorage.getItem(key)) return;

    const itemsEl = document.getElementById('items');
    if (itemsEl.querySelector('.item-row')) {
        // Items already present (analysis finished before we navigated back).
        sessionStorage.removeItem(key);
        return;
    }

    itemsEl.innerHTML = '<div class="analyse-scanning"><span class="spinner"></span>Scanning&hellip;</div>';

    let attempts = 0;
    const maxAttempts = 30; // ~60 s at 2 s intervals
    function poll() {
        if (attempts++ >= maxAttempts) {
            sessionStorage.removeItem(key);
            itemsEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-text">Upload a photo to extract items</div></div>';
            return;
        }
        fetch('/areas/' + areaID + '/items')
            .then(function(r) { return r.text(); })
            .then(function(html) {
                if (html.includes('item-row')) {
                    sessionStorage.removeItem(key);
                    itemsEl.innerHTML = html;
                } else {
                    setTimeout(poll, 2000);
                }
            })
            .catch(function() { setTimeout(poll, 2000); });
    }
    setTimeout(poll, 2000);
})();

function startStream(evt, areaID) {
    evt.preventDefault();

    const form = document.getElementById('upload-form');
    const itemsEl = document.getElementById('items');
    const btnLabel = document.getElementById('upload-btn-label');
    const btnSpinner = document.getElementById('upload-btn-spinner');
    const uploadBtn = document.getElementById('upload-btn');
    const fileLabel = form.querySelector('.file-label');
    const fileInput = form.querySelector('input[type="file"]');

    // Capture form data BEFORE disabling inputs
    const formData = new FormData(form);

    // Show uploading state ‚Äî replace button label with spinner, disable file picker
    btnLabel.style.display = 'none';
    btnSpinner.style.display = 'inline-block';
    uploadBtn.disabled = true;
    fileLabel.classList.add('disabled');
    fileInput.disabled = true;

    // Clear items and show scanning indicator
    itemsEl.innerHTML = '<div class="analyse-scanning"><span class="spinner"></span>Scanning&hellip;</div><ul class="item-list" id="stream-list"></ul>';
    const list = document.getElementById('stream-list');
    let itemIndex = 0;

    // Persist in-progress state so a mid-stream navigation can resume
    const stateKey = 'analysing:' + areaID;
    sessionStorage.setItem(stateKey, '1');

    let streamFinished = false;

    fetch('/areas/' + areaID + '/photos/stream', {
        method: 'POST',
        body: formData,
    }).then(function(resp) {
        if (!resp.ok) {
            throw new Error('Upload failed: ' + resp.status);
        }

        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let buf = '';

        function pump() {
            return reader.read().then(function(result) {
                if (result.done) {
                    finishStream();
                    return;
                }
                buf += decoder.decode(result.value, { stream: true });

                // Process complete SSE lines
                const lines = buf.split('\n');
                buf = lines.pop(); // keep incomplete last chunk

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const json = line.slice(6).trim();
                        try {
                            const item = JSON.parse(json);
                            appendItem(item, ++itemIndex);
                        } catch(e) { /* skip malformed */ }
                    } else if (line.startsWith('event: done')) {
                        finishStream();
                        return;
                    }
                }
                return pump();
            });
        }

        return pump();
    }).catch(function(err) {
        console.error('Stream error:', err);
        finishStream(true);
    });

    function appendItem(item, idx) {
        const li = document.createElement('li');
        li.className = 'item-row item-row-entering';
        const idxStr = String(idx).padStart(2, '0');
        let meta = '';
        if (item.quantity || item.notes) {
            meta = '<div class="item-meta">';
            if (item.quantity) meta += '<span class="item-qty">' + esc(item.quantity) + '</span>';
            if (item.notes)    meta += '<span>' + esc(item.notes) + '</span>';
            meta += '</div>';
        }
        li.innerHTML =
            '<span class="item-index">' + idxStr + '</span>' +
            '<div class="item-body"><div class="item-name">' + esc(item.name) + '</div>' + meta + '</div>';
        list.appendChild(li);
    }

    function finishStream(error) {
        if (streamFinished) return;
        streamFinished = true;

        sessionStorage.removeItem(stateKey);

        // Remove scanning indicator
        const scanning = itemsEl.querySelector('.analyse-scanning');
        if (scanning) scanning.remove();

        // If no items landed, show empty state
        if (list && list.children.length === 0) {
            if (error) {
                itemsEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div class="empty-state-text">Analysis failed ‚Äî please try again</div></div>';
            } else {
                itemsEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-text">No items detected</div></div>';
            }
        }

        // Restore button and file picker
        btnLabel.style.display = '';
        btnSpinner.style.display = 'none';
        uploadBtn.disabled = false;
        fileLabel.classList.remove('disabled');
        fileInput.disabled = false;
    }

    function esc(str) {
        return String(str)
            .replace(/&/g,'&amp;')
            .replace(/</g,'&lt;')
            .replace(/>/g,'&gt;')
            .replace(/"/g,'&quot;');
    }
}
</script>
{{end}}
