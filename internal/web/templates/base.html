{{define "base"}}<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>kitchinv</title>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/htmx.min.js"
            integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC"
            crossorigin="anonymous"></script>
    <style>
        /* ── Design tokens ─────────────────────────────────── */
        :root {
            --bg: #f8fafc;
            --bg-gradient-from: #eff6ff;
            --bg-gradient-to: #eef2ff;
            --card-bg: #ffffff;
            --card-border: #e2e8f0;
            --card-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
            --card-shadow-hover: 0 4px 12px rgba(0,0,0,0.08), 0 2px 4px rgba(0,0,0,0.04);
            --text: #0f172a;
            --text-muted: #64748b;
            --text-faint: #94a3b8;
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --primary-bg: #eff6ff;
            --primary-gradient-from: #2563eb;
            --primary-gradient-to: #4f46e5;
            --danger: #dc2626;
            --danger-bg: #fef2f2;
            --success: #16a34a;
            --highlight-bg: #fef08a;
            --header-gradient-from: #dbeafe;
            --header-gradient-to: #e0e7ff;
            --radius: 0.75rem;
            --radius-sm: 0.5rem;
            --content-w: 720px;
            --header-h: 64px;
            --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        /* ── Reset ─────────────────────────────────────────── */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; -webkit-text-size-adjust: 100%; }

        body {
            font-family: var(--font);
            background: linear-gradient(135deg, var(--bg) 0%, var(--bg-gradient-from) 50%, var(--bg-gradient-to) 100%);
            color: var(--text);
            min-height: 100dvh;
        }

        a { color: inherit; text-decoration: none; }

        /* ── Header ────────────────────────────────────────── */
        .header {
            position: sticky;
            top: 0;
            z-index: 200;
            height: var(--header-h);
            background: rgba(255,255,255,0.82);
            backdrop-filter: blur(16px) saturate(1.2);
            -webkit-backdrop-filter: blur(16px) saturate(1.2);
            border-bottom: 1px solid var(--card-border);
        }
        .header-inner {
            max-width: var(--content-w);
            margin: 0 auto;
            height: 100%;
            padding: 0 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* ── Logo ──────────────────────────────────────────── */
        .logo {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            text-decoration: none;
            flex-shrink: 0;
        }
        .logo-icon {
            width: 34px;
            height: 34px;
            background: linear-gradient(135deg, var(--primary-gradient-from), var(--primary-gradient-to));
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .logo-icon svg { display: block; }
        .logo-text {
            display: flex;
            flex-direction: column;
            line-height: 1;
        }
        .logo-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text);
            letter-spacing: -0.01em;
        }
        .logo-subtitle {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 0.15rem;
        }

        /* ── Search bar in header ─────────────────────────── */
        .header-search {
            flex: 1;
            max-width: 320px;
            margin-left: auto;
            position: relative;
        }
        .header-search svg {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-faint);
            pointer-events: none;
        }
        .header-search input {
            width: 100%;
            font-family: var(--font);
            font-size: 0.8125rem;
            color: var(--text);
            background: var(--bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 0.5rem 0.75rem 0.5rem 2.25rem;
            outline: none;
            transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
        }
        .header-search input:focus {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }
        .header-search input::placeholder { color: var(--text-faint); }
        .search-clear {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            padding: 0.25rem;
            cursor: pointer;
            color: var(--text-faint);
            display: none;
            line-height: 0;
        }
        .search-clear:hover { color: var(--text-muted); }

        /* ── Page body ─────────────────────────────────────── */
        .page {
            max-width: var(--content-w);
            margin: 0 auto;
            padding: 1.5rem 1.25rem 3rem;
        }

        /* ── Area list ─────────────────────────────────────── */
        .area-list {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        /* ── Area card ─────────────────────────────────────── */
        .area-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--card-shadow);
            transition: box-shadow 0.2s, border-color 0.2s;
        }
        .area-card:hover {
            box-shadow: var(--card-shadow-hover);
            border-color: #cbd5e1;
        }

        .area-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.875rem 1rem;
            background: linear-gradient(135deg, var(--header-gradient-from), var(--header-gradient-to));
            border-bottom: 1px solid var(--card-border);
            gap: 0.5rem;
        }
        .area-card-name {
            font-size: 1rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-gradient-from), var(--primary-gradient-to));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            cursor: pointer;
            border: none;
            padding: 0;
            min-width: 0;
            outline: none;
        }
        .area-card-name-input {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text);
            background: white;
            border: 1px solid var(--primary);
            border-radius: var(--radius-sm);
            padding: 0.25rem 0.5rem;
            outline: none;
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
            width: 100%;
            max-width: 300px;
        }
        .area-card-actions {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            flex-shrink: 0;
        }

        /* ── Photo section ─────────────────────────────────── */
        .area-photo-section {
            position: relative;
        }
        .area-photo-img {
            display: block;
            width: 100%;
            max-height: 280px;
            object-fit: cover;
        }
        .area-photo-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            cursor: pointer;
        }
        .area-photo-section:hover .area-photo-overlay { opacity: 1; }
        .area-photo-overlay-text {
            color: white;
            font-size: 0.8125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }
        .area-photo-remove {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(0,0,0,0.5);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s, background 0.2s;
        }
        .area-photo-section:hover .area-photo-remove { opacity: 1; }
        .area-photo-remove:hover { background: var(--danger); }

        /* Analyzing state */
        .area-analysing-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(37,99,235,0.85), rgba(79,70,229,0.85));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        .area-analysing-text {
            color: white;
            font-size: 0.8125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Upload zone */
        .upload-zone {
            border: 2px dashed #cbd5e1;
            border-radius: var(--radius-sm);
            padding: 2rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            margin: 0.75rem 1rem;
        }
        .upload-zone:hover,
        .upload-zone.drag-over {
            border-color: var(--primary);
            background: var(--primary-bg);
        }
        .upload-zone-icon {
            color: var(--text-faint);
            margin-bottom: 0.5rem;
        }
        .upload-zone-text {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }
        .upload-zone-text strong {
            color: var(--primary);
            font-weight: 600;
        }
        .upload-zone input[type="file"] {
            display: none;
        }

        /* ── Items table ───────────────────────────────────── */
        .items-section {
            padding: 0 1rem 0.75rem;
        }
        .item-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8125rem;
        }
        .item-table thead th {
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--text-muted);
            text-align: left;
            padding: 0.5rem 0.5rem 0.375rem;
            background: linear-gradient(135deg, var(--header-gradient-from), var(--header-gradient-to));
            border-bottom: 1px solid var(--card-border);
        }
        .item-table thead th:first-child { border-radius: var(--radius-sm) 0 0 0; }
        .item-table thead th:last-child { border-radius: 0 var(--radius-sm) 0 0; }
        .item-row td {
            padding: 0.5rem;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
        }
        .item-row:last-child td { border-bottom: none; }
        .item-row:hover {
            background: #f8fafc;
        }
        .item-name-cell {
            font-weight: 500;
            color: var(--text);
            cursor: pointer;
        }
        .item-name-cell:hover {
            color: var(--primary);
        }
        .item-qty-badge {
            display: inline-block;
            background: var(--primary-bg);
            color: var(--primary);
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.125rem 0.5rem;
            border-radius: 999px;
        }
        .item-notes-cell {
            color: var(--text-muted);
            font-size: 0.75rem;
        }
        .item-actions {
            opacity: 0;
            transition: opacity 0.15s;
            display: flex;
            gap: 0.125rem;
        }
        .item-row:hover .item-actions { opacity: 1; }

        /* Items show/hide */
        .items-toggle {
            display: block;
            width: 100%;
            text-align: center;
            padding: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--primary);
            background: none;
            border: none;
            border-top: 1px solid #f1f5f9;
            cursor: pointer;
            transition: background 0.15s;
        }
        .items-toggle:hover { background: var(--primary-bg); }

        /* Add item row */
        .add-item-row {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem 0.5rem;
            align-items: center;
        }
        .add-item-row input {
            flex: 1;
            font-family: var(--font);
            font-size: 0.8125rem;
            color: var(--text);
            background: #f8fafc;
            border: 1px solid var(--card-border);
            border-radius: var(--radius-sm);
            padding: 0.375rem 0.5rem;
            outline: none;
            transition: border-color 0.15s;
        }
        .add-item-row input:focus {
            border-color: var(--primary);
            background: white;
        }
        .add-item-row input::placeholder { color: var(--text-faint); }

        /* Inline edit */
        .inline-edit-input {
            font-family: var(--font);
            font-size: 0.8125rem;
            color: var(--text);
            background: white;
            border: 1px solid var(--primary);
            border-radius: var(--radius-sm);
            padding: 0.25rem 0.375rem;
            outline: none;
            box-shadow: 0 0 0 2px rgba(37,99,235,0.1);
            width: 100%;
        }

        /* ── Buttons ───────────────────────────────────────── */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.375rem;
            font-family: var(--font);
            font-size: 0.8125rem;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.15s;
            -webkit-tap-highlight-color: transparent;
            white-space: nowrap;
            line-height: 1;
        }
        .btn:active { transform: scale(0.97); }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-gradient-from), var(--primary-gradient-to));
            color: white;
            padding: 0.625rem 1.125rem;
            box-shadow: 0 1px 3px rgba(37,99,235,0.25);
        }
        .btn-primary:hover { opacity: 0.9; box-shadow: 0 2px 6px rgba(37,99,235,0.3); }
        .btn-ghost {
            background: transparent;
            color: var(--text-muted);
            padding: 0.375rem;
            border-radius: var(--radius-sm);
        }
        .btn-ghost:hover { background: #f1f5f9; color: var(--text); }
        .btn-sm { padding: 0.375rem 0.625rem; font-size: 0.75rem; }
        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            background: transparent;
            color: var(--text-faint);
            border-radius: var(--radius-sm);
        }
        .btn-icon:hover { background: #f1f5f9; color: var(--text-muted); }
        .btn-icon-danger:hover { background: var(--danger-bg); color: var(--danger); }

        /* ── Empty state ───────────────────────────────────── */
        .empty-state {
            text-align: center;
            padding: 4rem 1rem;
            color: var(--text-muted);
        }
        .empty-state-icon {
            margin-bottom: 1rem;
            color: var(--text-faint);
        }
        .empty-state-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.375rem;
        }
        .empty-state-text {
            font-size: 0.875rem;
            line-height: 1.5;
            max-width: 300px;
            margin: 0 auto;
        }
        .empty-state .btn { margin-top: 1.25rem; }

        /* ── New area dialog ───────────────────────────────── */
        dialog {
            border: none;
            border-radius: var(--radius);
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            padding: 1.5rem;
            max-width: 380px;
            width: calc(100% - 2rem);
        }
        dialog::backdrop {
            background: rgba(15,23,42,0.4);
            backdrop-filter: blur(4px);
        }
        .dialog-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        .dialog-input {
            width: 100%;
            font-family: var(--font);
            font-size: 0.875rem;
            color: var(--text);
            background: var(--bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius-sm);
            padding: 0.625rem 0.75rem;
            outline: none;
            margin-bottom: 1rem;
            transition: border-color 0.15s;
        }
        .dialog-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }
        .dialog-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        .dialog-cancel {
            font-family: var(--font);
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text-muted);
            background: none;
            border: none;
            padding: 0.625rem 1rem;
            cursor: pointer;
            border-radius: var(--radius-sm);
        }
        .dialog-cancel:hover { background: #f1f5f9; }
        .dialog-error {
            font-size: 0.8125rem;
            color: var(--danger);
            margin: -0.5rem 0 0.75rem;
            padding: 0;
        }

        /* ── Animations ────────────────────────────────────── */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes itemSlideIn {
            from { opacity: 0; transform: translateX(-8px); }
            to   { opacity: 1; transform: translateX(0); }
        }
        .area-card { animation: fadeIn 0.25s ease both; }
        .item-row-entering { animation: itemSlideIn 0.2s ease both; }
        .spinner {
            width: 16px; height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }
        .spinner-dark {
            border-color: rgba(37,99,235,0.2);
            border-top-color: var(--primary);
        }

        /* ── No items state ────────────────────────────────── */
        .no-items-text {
            padding: 1rem;
            text-align: center;
            color: var(--text-faint);
            font-size: 0.8125rem;
        }

        /* ── Search highlights ─────────────────────────────── */
        mark {
            background: var(--highlight-bg);
            color: inherit;
            padding: 0.05em 0.15em;
            border-radius: 2px;
        }

        /* ── Toast notifications ──────────────────────────── */
        .toast-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .toast {
            background: var(--text);
            color: white;
            font-size: 0.8125rem;
            font-weight: 500;
            padding: 0.625rem 1rem;
            border-radius: var(--radius-sm);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: fadeIn 0.2s ease;
        }

        /* ── Mobile responsive ─────────────────────────────── */
        @media (max-width: 640px) {
            .header-search { max-width: none; }
            .logo-text { display: none; }
            .item-actions { opacity: 1; }
        }

        /* Photo controls on touch: show only when .photo-controls-visible is set */
        @media (hover: none) {
            .area-photo-section.photo-controls-visible .area-photo-overlay { opacity: 1; background: rgba(0,0,0,0.35); }
            .area-photo-section.photo-controls-visible .area-photo-remove { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- ── Header ──────────────────────────────────────────── -->
    <header class="header">
        <div class="header-inner">
            <a class="logo" href="/areas">
                <div class="logo-icon">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9 22 9 12 15 12 15 22"/>
                    </svg>
                </div>
                <div class="logo-text">
                    <span class="logo-title">Household Inventory</span>
                    <span class="logo-subtitle">Track what you have</span>
                </div>
            </a>

            <div class="header-search" data-testid="search-bar">
                <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                </svg>
                <input type="search" data-testid="search-input" placeholder="Search items..." autocomplete="off" autocorrect="off" spellcheck="false">
                <button class="search-clear" data-testid="search-clear" type="button" aria-label="Clear search">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    {{template "content" .}}

    <!-- ── Toast container ─────────────────────────────────── -->
    <div class="toast-container" id="toast-container"></div>

    <script>
    /* ── Toast system ───────────────────────────────────── */
    function showToast(msg) {
        var c = document.getElementById('toast-container');
        var el = document.createElement('div');
        el.className = 'toast';
        el.textContent = msg;
        c.appendChild(el);
        setTimeout(function() { el.remove(); }, 3000);
    }

    /* ── Escape HTML ────────────────────────────────────── */
    function esc(str) {
        return String(str)
            .replace(/&/g,'&amp;')
            .replace(/</g,'&lt;')
            .replace(/>/g,'&gt;')
            .replace(/"/g,'&quot;');
    }

    /* ── New area dialog ────────────────────────────────── */
    function openNewAreaDialog() {
        var d = document.getElementById('new-area-dialog');
        if (d) { d.showModal(); d.querySelector('input').focus(); }
    }

    function submitNewArea(evt) {
        evt.preventDefault();
        var form = evt.target;
        var nameInput = form.querySelector('input[name="name"]');
        var errorEl = form.querySelector('[data-testid="dialog-error"]');
        var name = nameInput.value.trim();
        if (!name) return;
        if (errorEl) errorEl.style.display = 'none';
        fetch('/areas', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: 'name=' + encodeURIComponent(name),
        }).then(function(resp) {
            if (!resp.ok) return resp.text().then(function(msg) { throw new Error(msg.trim()); });
            return resp.text();
        }).then(function(html) {
            var list = document.getElementById('area-list');
            var es = document.querySelector('[data-testid="empty-state"]');
            if (es) es.remove();
            // Insert before the "new area" button, re-creating it if it was removed.
            var btnWrap = document.getElementById('new-area-btn-wrap');
            if (!btnWrap) {
                var btnWrapHTML = '<div id="new-area-btn-wrap" style="text-align:center; padding-top: 0.5rem;">' +
                    '<button class="btn btn-primary" onclick="openNewAreaDialog()" data-testid="new-area-btn">' +
                    '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>' +
                    'Add Area</button></div>';
                list.insertAdjacentHTML('beforeend', btnWrapHTML);
                btnWrap = document.getElementById('new-area-btn-wrap');
            }
            btnWrap.insertAdjacentHTML('beforebegin', html);
            btnWrap.style.display = '';
            nameInput.value = '';
            document.getElementById('new-area-dialog').close();
            showToast('Area created');
        }).catch(function(err) {
            if (errorEl) {
                errorEl.textContent = (err && err.message) ? err.message : 'Failed to create area';
                errorEl.style.display = '';
            }
        });
    }

    /* ── Delete area ────────────────────────────────────── */
    function deleteArea(areaID) {
        if (!confirm('Delete this area and all its items?')) return;
        fetch('/areas/' + areaID, { method: 'DELETE' })
        .then(function(resp) {
            if (!resp.ok) throw new Error('Failed');
            var card = document.querySelector('[data-testid="area-card-' + areaID + '"]');
            if (card) card.remove();
            // Show empty state if no cards left.
            var list = document.getElementById('area-list');
            if (list && !list.querySelector('.area-card')) {
                var btn = document.getElementById('new-area-btn-wrap');
                if (btn) btn.remove();
                var emptyHTML = '<div data-testid="empty-state" class="empty-state">' +
                    '<div class="empty-state-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg></div>' +
                    '<div class="empty-state-title">No areas yet</div>' +
                    '<div class="empty-state-text">Add your first storage area to start tracking inventory.</div>' +
                    '<button class="btn btn-primary" onclick="openNewAreaDialog()" data-testid="new-area-btn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>Add Area</button></div>';
                list.insertAdjacentHTML('afterbegin', emptyHTML);
            }
            showToast('Area deleted');
        }).catch(function() { showToast('Failed to delete area'); });
    }

    /* ── Rename area ────────────────────────────────────── */
    function startRenameArea(areaID) {
        var nameEl = document.querySelector('[data-testid="area-name-' + areaID + '"]');
        if (!nameEl) return;
        var current = nameEl.textContent;
        var input = document.createElement('input');
        input.className = 'area-card-name-input';
        input.value = current;
        input.setAttribute('data-area-id', areaID);
        nameEl.replaceWith(input);
        input.focus();
        input.select();

        function save() {
            var val = input.value.trim();
            if (!val || val === current) {
                // Revert.
                var span = document.createElement('span');
                span.className = 'area-card-name';
                span.setAttribute('data-testid', 'area-name-' + areaID);
                span.textContent = current;
                span.onclick = function() { startRenameArea(areaID); };
                input.replaceWith(span);
                return;
            }
            fetch('/areas/' + areaID, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: val}),
            }).then(function(resp) {
                if (!resp.ok) return resp.text().then(function(msg) { throw new Error(msg.trim()); });
                return resp.text();
            }).then(function(html) {
                // Replace the entire card.
                var card = document.querySelector('[data-testid="area-card-' + areaID + '"]');
                if (card) {
                    card.outerHTML = html;
                }
                showToast('Area renamed');
            }).catch(function(err) {
                var msg = (err && err.message) ? err.message : 'Failed to rename area';
                showToast(msg);
                var span = document.createElement('span');
                span.className = 'area-card-name';
                span.setAttribute('data-testid', 'area-name-' + areaID);
                span.textContent = current;
                span.onclick = function() { startRenameArea(areaID); };
                input.replaceWith(span);
            });
        }

        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); save(); }
            if (e.key === 'Escape') { input.value = current; save(); }
        });
        input.addEventListener('blur', save);
    }

    /* ── Photo upload + SSE streaming ──────────────────── */
    function triggerUpload(areaID) {
        var input = document.querySelector('[data-testid="photo-input-' + areaID + '"]');
        if (input) input.click();
    }

    function handleFileSelect(areaID, input) {
        if (!input.files || !input.files[0]) return;
        startStream(areaID, input.files[0]);
    }

    function setupPhotoTouchToggle(areaID) {
        var card = document.querySelector('[data-testid="area-card-' + areaID + '"]');
        if (!card) return;
        var section = card.querySelector('.area-photo-section');
        if (!section) return;

        section.addEventListener('touchstart', function(e) {
            var isVisible = section.classList.contains('photo-controls-visible');
            // If controls are hidden, show them and cancel the default action
            // so we don't also trigger the overlay's onclick (upload).
            if (!isVisible) {
                e.preventDefault();
                section.classList.add('photo-controls-visible');
                // Dismiss when user touches anywhere outside this section.
                function dismiss(ev) {
                    if (!section.contains(ev.target)) {
                        section.classList.remove('photo-controls-visible');
                        document.removeEventListener('touchstart', dismiss, true);
                    }
                }
                document.addEventListener('touchstart', dismiss, true);
            }
            // If controls are already visible, let the touch proceed normally
            // (overlay onclick or remove button onclick will fire).
        }, { passive: false });
    }

    function setupDragDrop(areaID) {
        var zone = document.querySelector('[data-testid="upload-zone-' + areaID + '"]');
        if (!zone) return;
        zone.addEventListener('dragenter', function(e) { e.preventDefault(); zone.classList.add('drag-over'); });
        zone.addEventListener('dragover', function(e) { e.preventDefault(); zone.classList.add('drag-over'); });
        zone.addEventListener('dragleave', function() { zone.classList.remove('drag-over'); });
        zone.addEventListener('drop', function(e) {
            e.preventDefault();
            zone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) startStream(areaID, e.dataTransfer.files[0]);
        });
    }

    function startStream(areaID, file) {
        var card = document.querySelector('[data-testid="area-card-' + areaID + '"]');
        if (!card) return;

        var photoSection = card.querySelector('.area-photo-section') || card.querySelector('.upload-zone');
        var itemsBody = card.querySelector('.items-tbody');
        var itemsSection = card.querySelector('.items-section');
        var noItemsText = card.querySelector('.no-items-text');
        var uploadZone = card.querySelector('[data-testid="upload-zone-' + areaID + '"]');

        // Snapshot current state so we can restore it on failure.
        var prevPhotoHTML = photoSection ? photoSection.outerHTML : null;
        var prevItemsHTML = itemsBody ? itemsBody.innerHTML : null;

        // Show photo preview.
        var previewUrl = URL.createObjectURL(file);
        var photoHTML = '<div class="area-photo-section">' +
            '<img src="' + previewUrl + '" class="area-photo-img" alt="Uploading...">' +
            '<div class="area-analysing-overlay" data-testid="analyzing-indicator-' + areaID + '">' +
            '<div class="spinner"></div>' +
            '<span class="area-analysing-text">Analyzing your space...</span>' +
            '</div></div>';

        if (uploadZone) {
            uploadZone.outerHTML = photoHTML;
        } else if (photoSection) {
            photoSection.outerHTML = photoHTML;
        }

        // Hide items section during analysis.
        if (itemsSection) {
            itemsSection.style.display = 'none';
            if (noItemsText) noItemsText.remove();
            if (itemsBody) itemsBody.innerHTML = '';
        } else {
            // Create a hidden items section to stream into.
            var photoEl = card.querySelector('.area-photo-section');
            if (photoEl) {
                photoEl.insertAdjacentHTML('afterend',
                    '<div class="items-section" style="display:none"><table class="item-table"><thead><tr>' +
                    '<th>Name</th><th>Qty</th><th>Notes</th><th></th>' +
                    '</tr></thead><tbody class="items-tbody"></tbody></table></div>');
            }
            itemsSection = card.querySelector('.items-section');
            itemsBody = card.querySelector('.items-tbody');
        }
        // Ensure a table body exists for streaming items into.
        if (itemsSection && !itemsBody) {
            var addRow = itemsSection.querySelector('.add-item-row');
            var tableHTML = '<table class="item-table"><thead><tr>' +
                '<th>Name</th><th>Qty</th><th>Notes</th><th></th>' +
                '</tr></thead><tbody class="items-tbody"></tbody></table>';
            if (addRow) {
                addRow.insertAdjacentHTML('beforebegin', tableHTML);
            } else {
                itemsSection.insertAdjacentHTML('afterbegin', tableHTML);
            }
            itemsBody = card.querySelector('.items-tbody');
        }

        // Disable file input.
        var fileInput = card.querySelector('[data-testid="photo-input-' + areaID + '"]');
        if (fileInput) fileInput.disabled = true;

        var formData = new FormData();
        formData.append('image', file);

        var streamFinished = false;
        fetch('/areas/' + areaID + '/photos/stream', {
            method: 'POST',
            body: formData,
        }).then(function(resp) {
            if (!resp.ok) throw new Error('Upload failed: ' + resp.status);
            var reader = resp.body.getReader();
            var decoder = new TextDecoder();
            var buf = '';

            function pump() {
                return reader.read().then(function(result) {
                    if (result.done) { finishStream(); return; }
                    buf += decoder.decode(result.value, { stream: true });
                    var lines = buf.split('\n');
                    buf = lines.pop();
                    for (var i = 0; i < lines.length; i++) {
                        var line = lines[i];
                        if (line.startsWith('data: ')) {
                            try {
                                var item = JSON.parse(line.slice(6).trim());
                                appendStreamItem(areaID, item);
                            } catch(e) { /* skip */ }
                        } else if (line.startsWith('event: done')) {
                            finishStream();
                            return;
                        }
                    }
                    return pump();
                });
            }
            return pump();
        }).catch(function(err) {
            console.error('Stream error:', err);
            finishStream(true);
        });

        function finishStream(error) {
            if (streamFinished) return;
            streamFinished = true;
            // Re-enable file input.
            if (fileInput) fileInput.disabled = false;

            if (error) {
                // Show toast first before any DOM changes.
                showToast('Upload failed — previous state restored');
                // Restore the previous photo section (upload zone or existing photo).
                var currentPhotoSec = card.querySelector('.area-photo-section') || card.querySelector('.upload-zone');
                if (prevPhotoHTML && currentPhotoSec) {
                    currentPhotoSec.outerHTML = prevPhotoHTML;
                    // Re-attach drop zone listener if it was an upload zone.
                    if (prevPhotoHTML.indexOf('upload-zone') !== -1) setupDropZone(areaID);
                }
                // Restore previous items and show items section.
                var tbody = card.querySelector('.items-tbody');
                if (tbody !== null && prevItemsHTML !== null) {
                    tbody.innerHTML = prevItemsHTML;
                }
                var itemsSec = card.querySelector('.items-section');
                if (itemsSec) itemsSec.style.display = '';
            } else {
                // Remove analyzing overlay.
                var overlay = card.querySelector('[data-testid="analyzing-indicator-' + areaID + '"]');
                if (overlay) overlay.remove();
                // Update photo section with server URL and controls.
                var photoSec = card.querySelector('.area-photo-section');
                if (photoSec) {
                    photoSec.innerHTML = '<img src="/areas/' + areaID + '/photo?t=' + Date.now() + '" class="area-photo-img" alt="Photo">' +
                        '<div class="area-photo-overlay" onclick="triggerUpload(' + areaID + ')"><span class="area-photo-overlay-text"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>Replace photo</span></div>' +
                        '<button class="area-photo-remove" onclick="event.stopPropagation();removePhoto(' + areaID + ')" aria-label="Remove photo"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>';
                    setupPhotoTouchToggle(areaID);
                }
                // Replace streamed item rows with server-rendered partial so
                // that all controls (delete, edit) and data-item-id attributes
                // are present and interactive (kitchinv-c0o).
                // Replace only the table inside .items-section to preserve the add-item-row.
                fetch('/areas/' + areaID + '/items')
                    .then(function(r) { return r.text(); })
                    .then(function(html) {
                        var itemsSection = card.querySelector('.items-section');
                        if (!itemsSection) return;
                        // Remove existing table and toggle button, keep add-item-row.
                        var oldTable = itemsSection.querySelector('.item-table');
                        if (oldTable) oldTable.remove();
                        var oldToggle = itemsSection.querySelector('.items-toggle');
                        if (oldToggle) oldToggle.remove();
                        var oldNoItems = itemsSection.querySelector('.no-items-text');
                        if (oldNoItems) oldNoItems.remove();
                        // Prepend the server-rendered table/toggle before add-item-row.
                        var addRow = itemsSection.querySelector('.add-item-row');
                        var tmp = document.createElement('div');
                        tmp.innerHTML = html;
                        while (tmp.firstChild) {
                            itemsSection.insertBefore(tmp.firstChild, addRow);
                        }
                        // Reveal items section now that analysis is complete.
                        itemsSection.style.display = '';
                    })
                    .catch(function(err) { console.error('failed to refresh items:', err); });
            }
        }
    }

    function appendStreamItem(areaID, item) {
        var card = document.querySelector('[data-testid="area-card-' + areaID + '"]');
        if (!card) return;
        var tbody = card.querySelector('.items-tbody');
        if (!tbody) return;
        var tr = document.createElement('tr');
        tr.className = 'item-row item-row-entering';
        tr.setAttribute('data-testid', 'item-row');
        tr.innerHTML =
            '<td class="item-name-cell">' + esc(item.name) + '</td>' +
            '<td>' + (item.quantity ? '<span class="item-qty-badge">' + esc(item.quantity) + '</span>' : '') + '</td>' +
            '<td class="item-notes-cell">' + esc(item.notes || '') + '</td>' +
            '<td></td>';
        tbody.appendChild(tr);
    }

    /* ── Remove photo ──────────────────────────────────── */
    function removePhoto(areaID) {
        fetch('/areas/' + areaID + '/photo', { method: 'DELETE' })
        .then(function(resp) {
            if (!resp.ok) throw new Error('Failed');
            return resp.text();
        }).then(function(html) {
            var card = document.querySelector('[data-testid="area-card-' + areaID + '"]');
            if (card) card.outerHTML = html;
            showToast('Photo removed');
        }).catch(function() { showToast('Failed to remove photo'); });
    }

    /* ── Add item ──────────────────────────────────────── */
    function addItem(evt, areaID) {
        if (evt.key && evt.key !== 'Enter') return;
        evt.preventDefault();
        var card = document.querySelector('[data-testid="area-card-' + areaID + '"]');
        if (!card) return;
        var nameInput = card.querySelector('.add-item-name');
        var qtyInput = card.querySelector('.add-item-qty');
        var notesInput = card.querySelector('.add-item-notes');
        var name = nameInput ? nameInput.value.trim() : '';
        if (!name) return;

        fetch('/areas/' + areaID + '/items', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: name,
                quantity: qtyInput ? qtyInput.value.trim() : '',
                notes: notesInput ? notesInput.value.trim() : '',
            }),
        }).then(function(resp) {
            if (!resp.ok) throw new Error('Failed');
            return resp.json();
        }).then(function(item) {
            var tbody = card.querySelector('.items-tbody');
            if (!tbody) return;
            var noItems = card.querySelector('.no-items-text');
            if (noItems) noItems.remove();
            var tr = document.createElement('tr');
            tr.className = 'item-row item-row-entering';
            tr.setAttribute('data-testid', 'item-row');
            tr.setAttribute('data-item-id', item.ID);
            tr.innerHTML =
                '<td class="item-name-cell" onclick="startEditItem(' + areaID + ',' + item.ID + ')">' + esc(item.Name) + '</td>' +
                '<td>' + (item.Quantity ? '<span class="item-qty-badge">' + esc(item.Quantity) + '</span>' : '') + '</td>' +
                '<td class="item-notes-cell">' + esc(item.Notes || '') + '</td>' +
                '<td class="item-actions"><button class="btn btn-icon btn-icon-danger" onclick="deleteItem(' + areaID + ',' + item.ID + ')" aria-label="Delete item"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></button></td>';
            tbody.appendChild(tr);
            if (nameInput) nameInput.value = '';
            if (qtyInput) qtyInput.value = '';
            if (notesInput) notesInput.value = '';
            if (nameInput) nameInput.focus();
            showToast('Item added');
        }).catch(function() { showToast('Failed to add item'); });
    }

    /* ── Delete item ───────────────────────────────────── */
    function deleteItem(areaID, itemID) {
        fetch('/areas/' + areaID + '/items/' + itemID, { method: 'DELETE' })
        .then(function(resp) {
            if (!resp.ok) throw new Error('Failed');
            var row = document.querySelector('tr[data-item-id="' + itemID + '"]');
            if (row) row.remove();
            showToast('Item deleted');
        }).catch(function() { showToast('Failed to delete item'); });
    }

    /* ── Edit item inline ──────────────────────────────── */
    function startEditItem(areaID, itemID) {
        var row = document.querySelector('tr[data-item-id="' + itemID + '"]');
        if (!row || row.classList.contains('editing')) return;
        row.classList.add('editing');

        var nameCell = row.querySelector('.item-name-cell');
        var qtyBadge = row.querySelector('.item-qty-badge');
        var notesCell = row.querySelector('.item-notes-cell');

        var origName = nameCell ? nameCell.textContent.trim() : '';
        var origQty = qtyBadge ? qtyBadge.textContent.trim() : '';
        var origNotes = notesCell ? notesCell.textContent.trim() : '';

        if (nameCell) {
            nameCell.innerHTML = '<input class="inline-edit-input" value="' + esc(origName) + '" data-field="name">';
        }
        var qtyCell = qtyBadge ? qtyBadge.parentElement : row.cells[1];
        if (qtyCell) {
            qtyCell.innerHTML = '<input class="inline-edit-input" value="' + esc(origQty) + '" data-field="qty" style="max-width:80px">';
        }
        if (notesCell) {
            notesCell.innerHTML = '<input class="inline-edit-input" value="' + esc(origNotes) + '" data-field="notes">';
        }

        var nameInput = row.querySelector('[data-field="name"]');
        if (nameInput) { nameInput.focus(); nameInput.select(); }

        var inputs = row.querySelectorAll('.inline-edit-input');
        inputs.forEach(function(inp) {
            inp.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') { e.preventDefault(); saveEdit(); }
                if (e.key === 'Escape') { e.preventDefault(); cancelEdit(); }
            });
            inp.addEventListener('blur', function() {
                // Delay to allow focus to move to another input in the same row.
                setTimeout(function() {
                    if (!row.contains(document.activeElement) || !document.activeElement.classList.contains('inline-edit-input')) {
                        saveEdit();
                    }
                }, 100);
            });
        });

        function saveEdit() {
            if (!row.classList.contains('editing')) return;
            row.classList.remove('editing');

            var ni = row.querySelector('[data-field="name"]');
            var qi = row.querySelector('[data-field="qty"]');
            var noi = row.querySelector('[data-field="notes"]');
            var newName = ni ? ni.value.trim() : origName;
            var newQty = qi ? qi.value.trim() : origQty;
            var newNotes = noi ? noi.value.trim() : origNotes;

            if (!newName) newName = origName;

            // Optimistically update UI.
            revertCells(newName, newQty, newNotes);

            if (newName === origName && newQty === origQty && newNotes === origNotes) return;

            fetch('/areas/' + areaID + '/items/' + itemID, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: newName, quantity: newQty, notes: newNotes}),
            }).then(function(resp) {
                if (!resp.ok) throw new Error('Failed');
                showToast('Item updated');
            }).catch(function() {
                revertCells(origName, origQty, origNotes);
                showToast('Failed to update item');
            });
        }

        function cancelEdit() {
            row.classList.remove('editing');
            revertCells(origName, origQty, origNotes);
        }

        function revertCells(name, qty, notes) {
            if (nameCell || row.cells[0]) {
                var nc = nameCell || row.cells[0];
                nc.innerHTML = esc(name);
                nc.className = 'item-name-cell';
                nc.onclick = function() { startEditItem(areaID, itemID); };
            }
            var qc = qtyCell || row.cells[1];
            if (qc) {
                qc.innerHTML = qty ? '<span class="item-qty-badge">' + esc(qty) + '</span>' : '';
            }
            if (notesCell || row.cells[2]) {
                var notc = notesCell || row.cells[2];
                notc.innerHTML = esc(notes);
                notc.className = 'item-notes-cell';
            }
        }
    }

    /* ── Search / filter ───────────────────────────────── */
    (function() {
        var searchInput = document.querySelector('[data-testid="search-input"]');
        var clearBtn = document.querySelector('[data-testid="search-clear"]');
        if (!searchInput) return;

        var debounceTimer;
        searchInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            var q = searchInput.value.trim().toLowerCase();
            clearBtn.style.display = q ? 'block' : 'none';
            debounceTimer = setTimeout(function() { filterCards(q); }, 100);
        });

        if (clearBtn) {
            clearBtn.addEventListener('click', function() {
                searchInput.value = '';
                clearBtn.style.display = 'none';
                filterCards('');
                searchInput.focus();
            });
        }

        function filterCards(q) {
            var cards = document.querySelectorAll('.area-card');
            var anyVisible = false;
            cards.forEach(function(card) {
                // Remove old highlights.
                card.querySelectorAll('mark').forEach(function(m) {
                    m.replaceWith(m.textContent);
                });

                if (!q) {
                    // Restore all rows to their natural visibility state.
                    card.querySelectorAll('.item-row').forEach(function(row) {
                        var isHidden = row.classList.contains('item-row-hidden');
                        row.style.display = isHidden ? 'none' : '';
                    });
                    // Restore the "show more" toggle.
                    var toggle = card.querySelector('.items-toggle');
                    if (toggle) toggle.style.display = '';
                    card.style.display = '';
                    anyVisible = true;
                    return;
                }

                // Filter item rows — match against name, qty, and notes cells.
                var rows = card.querySelectorAll('.item-row');
                var cardHasMatch = false;

                // Also check the area name itself.
                var areaName = card.querySelector('.area-card-name');
                var areaNameMatch = areaName && areaName.textContent.toLowerCase().indexOf(q) >= 0;
                if (areaNameMatch) cardHasMatch = true;

                rows.forEach(function(row) {
                    var text = row.textContent.toLowerCase();
                    if (text.indexOf(q) >= 0) {
                        row.style.display = '';
                        cardHasMatch = true;
                    } else {
                        row.style.display = 'none';
                    }
                });

                // Hide the "show more" toggle while filtering — all matching rows are visible.
                var toggle = card.querySelector('.items-toggle');
                if (toggle) toggle.style.display = q ? 'none' : '';

                if (cardHasMatch) {
                    card.style.display = '';
                    anyVisible = true;
                    highlightText(card, q);
                } else {
                    card.style.display = 'none';
                }
            });

            // Show/hide "no matches" state.
            var noMatch = document.getElementById('no-search-matches');
            if (!q) {
                if (noMatch) noMatch.remove();
            } else if (!anyVisible) {
                if (!noMatch) {
                    var list = document.getElementById('area-list');
                    if (list) {
                        list.insertAdjacentHTML('beforeend',
                            '<div id="no-search-matches" class="empty-state" style="padding:2rem">' +
                            '<div class="empty-state-icon"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg></div>' +
                            '<div class="empty-state-text">No matches found</div></div>');
                    }
                }
            } else {
                if (noMatch) noMatch.remove();
            }
        }

        function highlightText(container, q) {
            var walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null, false);
            var nodes = [];
            while (walker.nextNode()) nodes.push(walker.currentNode);
            nodes.forEach(function(node) {
                var text = node.textContent;
                var lower = text.toLowerCase();
                var idx = lower.indexOf(q);
                if (idx < 0 || !node.parentNode || node.parentNode.tagName === 'SCRIPT' || node.parentNode.tagName === 'STYLE') return;
                var before = text.slice(0, idx);
                var match = text.slice(idx, idx + q.length);
                var after = text.slice(idx + q.length);
                var frag = document.createDocumentFragment();
                if (before) frag.appendChild(document.createTextNode(before));
                var mark = document.createElement('mark');
                mark.textContent = match;
                frag.appendChild(mark);
                if (after) frag.appendChild(document.createTextNode(after));
                node.parentNode.replaceChild(frag, node);
            });
        }
    })();

    /* ── Items expand/collapse ─────────────────────────── */
    function toggleItems(areaID) {
        var card = document.querySelector('[data-testid="area-card-' + areaID + '"]');
        if (!card) return;
        var hidden = card.querySelectorAll('.item-row-hidden');
        var btn = card.querySelector('.items-toggle');
        if (hidden.length > 0) {
            hidden.forEach(function(r) { r.classList.remove('item-row-hidden'); r.style.display = ''; });
            if (btn) btn.textContent = 'Show fewer';
            if (btn) btn.setAttribute('data-expanded', 'true');
        } else {
            var rows = card.querySelectorAll('.item-row');
            for (var i = 10; i < rows.length; i++) {
                rows[i].classList.add('item-row-hidden');
                rows[i].style.display = 'none';
            }
            if (btn) btn.textContent = 'Show ' + (rows.length - 10) + ' more';
            if (btn) btn.removeAttribute('data-expanded');
        }
    }

    /* ── Init drag-drop and touch-toggle on page load ──── */
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.area-card').forEach(function(card) {
            var testid = card.getAttribute('data-testid') || '';
            var m = testid.match(/area-card-(\d+)/);
            if (m) {
                var id = parseInt(m[1], 10);
                setupDragDrop(id);
                setupPhotoTouchToggle(id);
            }
        });
    });
    </script>
</body>
</html>
{{end}}
